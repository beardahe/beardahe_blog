---
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import Layout from '../../../layouts/Layout.astro';
import PostList from '../../../components/PostList.astro';
import Pagination from '../../../components/Pagination.astro';
import ContactLinks from '../../../components/ContactLinks.astro';
import { PAGE_SIZE, sortPostsDesc } from '../../../utils/blog';

export async function getStaticPaths() {
  const allPosts = sortPostsDesc(await getCollection('blog'));
  const totalPages = Math.max(1, Math.ceil(allPosts.length / PAGE_SIZE));

  if (totalPages <= 1) return [];

  return Array.from({ length: totalPages - 1 }, (_, index) => {
    const currentPage = index + 2;
    const start = (currentPage - 1) * PAGE_SIZE;
    const posts = allPosts.slice(start, start + PAGE_SIZE);

    return {
      params: { page: String(currentPage) },
      props: { posts, currentPage, totalPages },
    };
  });
}

type Props = {
  posts: CollectionEntry<'blog'>[];
  currentPage: number;
  totalPages: number;
};

const { posts, currentPage, totalPages } = Astro.props as Props;
---

<Layout title={`博客 - 第 ${currentPage} 页 | Dahe Blog`}>
  <section class="stack">
    <h1 class="page-title">全部文章</h1>
    <p class="page-subtitle">第 {currentPage} 页，共 {totalPages} 页</p>
    <ContactLinks />
    <PostList posts={posts} emptyText="这一页没有文章。" />
    <Pagination currentPage={currentPage} totalPages={totalPages} />
  </section>
</Layout>
